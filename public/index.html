<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Panel Maestro üß†</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    body {
      background: #0e0e0e;
      color: #f0f0f0;
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #00ffaa;
      margin-bottom: 24px;
    }
    section {
      background: #1b1b1b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,255,170,0.08);
    }
    h2 {
      color: #9ee5c1;
      margin-top: 0;
      font-size: 18px;
    }
    button {
      background: #00c28a;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      margin: 6px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #00e1a3;
      transform: scale(1.03);
    }
    .acciones button {
      background: #555;
      font-size: 13px;
      padding: 6px 12px;
    }
    .acciones button:hover { background: #666; }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }
    li {
      padding: 8px;
      background: #121212;
      border-radius: 6px;
      margin-bottom: 6px;
      border: 1px solid #2b2b2b;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    li b { color: #00ff99; }
    .badge {
      background: #ff5c5c;
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .counter {
      font-size: 15px;
      color: #00ffaa;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Panel Maestro üß†</h1>

  <!-- DASHBOARD -->
  <section>
    <h2>Dashboard principal</h2>
    <p>Controla los dispositivos y gestiona los servidores desde aqu√≠.</p>
    <button id="btnOpenClients">üì± Ver dispositivos</button>
    <button id="btnOpenServers">üß© Gestor de servidores</button>
    <span class="counter" id="clientCount">Clientes conectados: 0</span>
  </section>

  <!-- LICENCIAS -->
  <section id="licencias">
    <h2>üîë Licencias activas</h2>
    <div class="acciones">
      <button id="btnLicRefresh">üîÑ Refrescar</button>
      <button id="btnLicNew">‚ûï Generar key</button>
    </div>
    <ul id="licList"></ul>
  </section>

  <!-- SCRIPTS -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ============================================================
    // üåê COMPATIBILIDAD: Electron + Web
    // ============================================================
    let ipcRenderer = null;
    try { ipcRenderer = require('electron').ipcRenderer; } catch {}

    // ==============================
    // üåê DETECCI√ìN AUTOM√ÅTICA DEL API
    // ==============================
    let api = location.origin;
    const defaultLocal = "http://localhost:3000";

    if (location.origin.startsWith("file://") || !location.origin.includes("http")) {
      api = localStorage.getItem("masterIP") || defaultLocal;
      if (!api.startsWith("http")) api = "http://" + api;
      console.log("‚öôÔ∏è Cargando IP guardada o por defecto:", api);
    }

    console.log("üåê Conectando al panel:", api);

    // ==============================
    // üîå CONEXI√ìN SOCKET.IO
    // ==============================
    const socket = io(api, { transports: ['websocket'], reconnection: true });
    const clientCount = document.getElementById('clientCount');

    function updateClientCounter(list) {
      if (!Array.isArray(list)) return;
      const online = list.filter(x => x.estado === 'online').length;
      clientCount.textContent = `Clientes conectados: ${online}`;
    }

    socket.on('connect', () => {
      console.log("‚úÖ Conectado al servidor maestro");
      socket.emit('getClientes');
    });

    socket.on('clientesList', (list) => updateClientCounter(list));
    socket.on('updateClientes', (list) => updateClientCounter(list));
    socket.on('disconnect', () => clientCount.textContent = "Clientes conectados: 0");

    // ==============================
    // ü™ü VENTANAS SECUNDARIAS
    // ==============================
    document.getElementById('btnOpenClients').addEventListener('click', () => {
      if (ipcRenderer) ipcRenderer.send('open-clients-window');
      else window.location.href = 'render.html'; // web
    });

    document.getElementById('btnOpenServers').addEventListener('click', () => {
      if (ipcRenderer) ipcRenderer.send('open-servers-window');
      else window.location.href = 'gestor.html'; // web
    });

    // ==============================
    // üîë LICENCIAS
    // ==============================
    async function loadLic() {
      const ul = document.getElementById('licList');
      ul.innerHTML = '<li class="muted">Cargando...</li>';
      try {
        const res = await fetch(api + '/api/licencias');
        const json = await res.json();
        const data = json.data || [];
        ul.innerHTML = '';
        if (!data.length) {
          ul.innerHTML = '<li class="muted">No hay licencias generadas a√∫n.</li>';
          return;
        }
        data.forEach(l => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div>
              <b>${l.key}</b> ‚Äî ${l.cliente || 'Sin nombre'}
              ${l.activo === false ? '<span class="badge">revocada</span>' : ''}
            </div>
            <div>
              <button onclick="revokeKey('${l.key}')">‚õî Revocar</button>
            </div>`;
          ul.appendChild(li);
        });
      } catch (e) {
        console.error("‚ùå Error al cargar licencias:", e);
        ul.innerHTML = '<li class="muted">Error al cargar licencias.</li>';
      }
    }

    async function revokeKey(key) {
      if (!confirm('¬øRevocar la key ' + key + '?')) return;
      await fetch(api + '/revoke-key', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key })
      });
      loadLic();
    }

    document.getElementById('btnLicRefresh').addEventListener('click', loadLic);
    document.getElementById('btnLicNew').addEventListener('click', async () => {
      const nombre = prompt('Nombre del cliente:');
      if (!nombre) return;
      await fetch(api + '/crearLicencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre })
      });
      loadLic();
    });

    loadLic();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log('‚úÖ Service Worker registrado'))
      .catch(err => console.error('‚ùå SW error:', err));
  }
  </script>

</body>
</html>
