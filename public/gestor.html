<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>üß© Gestor de servidores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root {
      --color-bg: #0e0e0e;
      --color-text: #f0f0f0;
      --color-accent: #00ffaa;
      --color-btn: #00c28a;
      --color-btn-hover: #00e1a3;
      --color-danger: #ff5252;
      --color-danger-hover: #ff7373;
      --color-card: #1a1a1a;
      --color-border: #2b2b2b;
    }
    body { background: var(--color-bg); color: var(--color-text); font-family: "Segoe UI", Arial, sans-serif; margin: 20px; }
    h1 { color: var(--color-accent); text-align: center; margin-bottom: 10px; }
    .nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .nav button { background: var(--color-btn); color: #fff; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
    .nav button:hover { background: var(--color-btn-hover); transform: scale(1.05); }
    .panel { background: var(--color-card); border-radius: 12px; padding: 20px; box-shadow: 0 0 10px rgba(0,255,170,0.08); margin-bottom: 25px; }
    .panel h2 { margin-top: 0; color: var(--color-accent); font-size: 18px; display:flex; align-items:center; gap:10px;}
    .input-row { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    input, select { background: #151515; color:#eee; border:1px solid var(--color-border); border-radius:6px; padding:8px 10px; font-size:14px; min-width:240px; }
    input[type="file"] { width: auto; }
    button { background: var(--color-btn); color: #fff; border: none; border-radius: 8px; padding: 8px 14px; margin: 4px; cursor: pointer; transition: all 0.2s; }
    button:hover { background: var(--color-btn-hover); transform: scale(1.03); }
    .danger { background: var(--color-danger); }
    .danger:hover { background: var(--color-danger-hover); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
    th { background: #121212; color: var(--color-accent); padding: 10px; }
    td { padding: 8px; border-bottom: 1px solid var(--color-border); text-align: center; word-break: break-all; }
    tr:hover { background: rgba(0,255,170,0.05); }
    .footer { text-align: center; margin-top: 25px; font-size: 13px; color: #999; }
    .progress-wrap { width:100%; max-width:560px; margin:10px auto 0; }
    .progress { width: 100%; height: 10px; background:#101010; border:1px solid var(--color-border); border-radius: 999px; overflow: hidden; }
    .progress .bar { height:100%; width:0%; background: linear-gradient(90deg, #00ffaa, #00c28a); transition: width .1s ease; }
    .progress-info { text-align:center; font-size:12px; color:#bbb; margin-top:6px; }
    .muted { color:#999; font-size:13px; }
    .inline { display:inline-flex; align-items:center; gap:8px; }
    .hidden { display:none !important; }
    .badge { background:#0f2b22; color:#8ef9d1; border:1px solid #1c4f40; padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <h1>üß© Gestor de servidores</h1>

  <div class="nav">
    <button onclick="window.location.href='index.html'">üè† Panel principal</button>
    <button onclick="window.location.href='render.html'">üì± Ver dispositivos</button>
  </div>

  <!-- üì± Dispositivos conectados -->
  <div class="panel">
    <h2>üì± Dispositivos conectados <span id="devCount" class="badge">0</span></h2>
    <div class="input-row">
      <span class="inline muted">Destino:</span>
      <select id="deviceSelect">
        <option value="">‚Äî Selecciona un dispositivo (licencia) ‚Äî</option>
      </select>
      <span class="muted">Solo se listan online/autenticados con licencia.</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Licencia</th>
          <th>Modelo</th>
          <th>Estado</th>
          <th>√öltima conexi√≥n</th>
        </tr>
      </thead>
      <tbody id="devTable">
        <tr><td colspan="5" class="muted">Esperando conexi√≥n‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <!-- üì¶ Subir ZIP -->
  <div class="panel">
    <h2>üì¶ Subir nuevo servidor (archivo .zip)</h2>
    <form id="uploadForm" enctype="multipart/form-data" class="input-row">
      <input type="text" name="name" placeholder="Nombre del servidor" required />
      <input type="file" name="serverZip" accept=".zip" required />
      <button type="submit">‚¨ÜÔ∏è Subir servidor</button>
    </form>
    <div id="progressWrap" class="progress-wrap hidden">
      <div class="progress"><div id="uploadBar" class="bar"></div></div>
      <div id="uploadInfo" class="progress-info">Listo.</div>
    </div>
  </div>

  <!-- üìã Lista -->
  <div class="panel">
    <h2>üìã Lista de servidores</h2>
    <div class="input-row" id="sendHintRow" class="hidden">
      <span class="muted">Selecciona un ‚ÄúDestino‚Äù arriba y usa <b>üì§ Enviar al dispositivo</b> en la fila del servidor.</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Archivo ZIP</th>
          <th>Tama√±o</th>
          <th>Licencias activas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="srvTable">
        <tr><td colspan="6" style="color:#777;">Cargando...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">Minecraft Render Server Dashboard ¬© 2025</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const defaultLocal = "http://localhost:10000";
    let api = location.origin;
    if (location.origin.startsWith("file://") || !location.origin.includes("http")) {
      api = localStorage.getItem("masterIP") || defaultLocal;
      if (!api.startsWith("http")) api = "http://" + api;
    }

    const srvTable = document.getElementById("srvTable");
    const devTable = document.getElementById("devTable");
    const devCount = document.getElementById("devCount");
    const deviceSelect = document.getElementById("deviceSelect");
    const sendHintRow = document.getElementById("sendHintRow");
    const progressWrap = document.getElementById("progressWrap");
    const uploadBar = document.getElementById("uploadBar");
    const uploadInfo = document.getElementById("uploadInfo");

    const socket = io(api, { transports: ["websocket", "polling"] });
    socket.on("connect", () => console.log("üîå Socket conectado"));
    socket.on("disconnect", () => console.log("üîå Socket desconectado"));

    socket.on("updateClientes", (list = []) => {
      renderDevices(list);
      toggleSendFeatures(list);
    });

    function toggleSendFeatures(list) {
      const onlineLic = list.filter(c => (c.estado !== "offline") && (c.licencia && c.licencia !== "-"));
      devCount.textContent = onlineLic.length;
      if (onlineLic.length > 0) sendHintRow.classList.remove("hidden");
      else sendHintRow.classList.add("hidden");
    }

    function renderDevices(list = []) {
      const prevSelected = deviceSelect.value;
      const onlineWithKey = list.filter(c => c.licencia && c.licencia !== "-" && c.licencia !== "sin clave")
                                .sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||""));

      deviceSelect.innerHTML = '<option value="">‚Äî Selecciona un dispositivo (licencia) ‚Äî</option>';
      for (const c of onlineWithKey) {
        const opt = document.createElement("option");
        opt.value = c.licencia;
        opt.textContent = `${c.nombre || "Desconocido"} ‚Äî ${c.licencia} (${c.modelo || "‚Äî"})`;
        deviceSelect.appendChild(opt);
      }
      if (prevSelected && onlineWithKey.some(c => c.licencia === prevSelected)) deviceSelect.value = prevSelected;

      devTable.innerHTML = "";
      if (!list.length) {
        devTable.innerHTML = '<tr><td colspan="5" class="muted">Sin dispositivos todav√≠a.</td></tr>';
        devCount.textContent = "0";
        return;
      }

      for (const c of list) {
        const color = c.estado === "online" ? "style='color:#00ffaa;'" :
                      c.estado === "autenticado" ? "style='color:#5be1ff;'" :
                      "style='color:#777;'";
        const emoji = c.estado === "online" ? "üü¢" :
                      c.estado === "autenticado" ? "üîµ" : "‚ö´";
        devTable.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${c.nombre || "‚Äî"}</td>
            <td>${c.licencia || "-"}</td>
            <td>${c.modelo || "‚Äî"}</td>
            <td ${color}>${emoji} ${c.estado || "‚Äî"}</td>
            <td>${c.ultimaConexion ? new Date(c.ultimaConexion).toLocaleString() : "‚Äî"}</td>
          </tr>
        `);
      }
      devCount.textContent = list.length;
    }

    async function loadServers() {
      srvTable.innerHTML = '<tr><td colspan="6" style="color:#777;">Cargando...</td></tr>';
      try {
        const res = await fetch(api + "/api/servers");
        const servers = await res.json();
        srvTable.innerHTML = "";
        if (!servers.length) {
          srvTable.innerHTML = '<tr><td colspan="6" style="color:#777;">No hay servidores registrados a√∫n</td></tr>';
          return;
        }
        servers.forEach(s => {
          const fileName = s.file ? s.file.split("/").pop() : "-";
          srvTable.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${s.id}</td>
              <td>${s.name}</td>
              <td>${fileName}</td>
              <td>${s.sizeMB || "‚Äî"}</td>
              <td>${s.assignedCount || 0}</td>
              <td>
                <button onclick="downloadServer('${s.file}')">‚¨áÔ∏è Descargar</button>
                <button onclick="assignServerPrompt(${s.id})">üéØ Asignar</button>
                <button onclick="sendToSelected(${s.id})">üì§ Enviar al dispositivo</button>
                <button class="danger" onclick="deleteServer(${s.id})">üóëÔ∏è Eliminar</button>
              </td>
            </tr>
          `);
        });
      } catch (e) {
        console.error("‚ùå Error al cargar servidores:", e);
        srvTable.innerHTML = '<tr><td colspan="6" style="color:#f55;">Error al cargar lista.</td></tr>';
      }
    }

    // üì§ Asignar servidor a licencia
    async function assignServerPrompt(serverId) {
      const license = prompt("Introduce la licencia a la que asignar este servidor:");
      if (!license) return;
      try {
        const res = await fetch(api + "/api/assign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ license, serverId })
        });
        const data = await res.json();
        if (data.success) {
          alert("‚úÖ " + (data.message || "Servidor asignado correctamente."));
          loadServers();
        } else {
          alert("‚ö†Ô∏è Error: " + (data.error || "No se pudo asignar."));
        }
      } catch (err) {
        console.error("‚ùå Error de conexi√≥n:", err);
        alert("‚ùå Error de conexi√≥n con el servidor.");
      }
    }

    // üì§ Enviar ZIP manualmente
    function sendToSelected(serverId) {
      const license = deviceSelect.value;
      if (!license) return alert("Selecciona un dispositivo destino (licencia).");
      fetch(api + "/api/sendToDevice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ license, serverId })
      })
      .then(r => r.json())
      .then(data => alert(data.success ? "üì§ Enviado al dispositivo" : "‚ö†Ô∏è " + (data.error || "No se pudo enviar.")))
      .catch(()=> alert("‚ùå Error de conexi√≥n."));
    }

    function downloadServer(filePath) {
      if (!filePath) return alert("Archivo no disponible.");
      window.open(api + "/api/download?file=" + encodeURIComponent(filePath), "_blank");
    }

    async function deleteServer(id) {
      if (!confirm("¬øSeguro que deseas eliminar este servidor ZIP?")) return;
      const res = await fetch(api + "/api/deleteServer/" + id, { method: "DELETE" });
      const data = await res.json();
      alert(data.success ? "üóëÔ∏è Servidor eliminado correctamente." : "‚ö†Ô∏è Error: " + (data.error || "No se pudo eliminar."));
      loadServers();
    }

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      progressWrap.classList.remove("hidden");
      setProgress(0, "Preparando subida...");
      const xhr = new XMLHttpRequest();
      xhr.open("POST", api + "/api/servers", true);
      xhr.upload.onprogress = (evt) => {
        if (evt.lengthComputable) setProgress(Math.round((evt.loaded / evt.total) * 100), `Subiendo...`);
      };
      xhr.onload = () => {
        try {
          const data = JSON.parse(xhr.responseText || "{}");
          if (xhr.status === 200 && data.success) {
            setProgress(100, "‚úÖ Subida completa.");
            form.reset(); loadServers();
          } else setProgress(0, "‚ö†Ô∏è Error: " + (data.error || "No se pudo subir."));
        } catch { setProgress(0, "‚ö†Ô∏è Error inesperado."); }
        setTimeout(()=>{ progressWrap.classList.add("hidden"); setProgress(0,"Listo."); },1500);
      };
      xhr.onerror = () => {
        setProgress(0, "‚ùå Error al conectar con el servidor.");
        setTimeout(()=>{ progressWrap.classList.add("hidden"); },1500);
      };
      xhr.send(formData);
    });

    function setProgress(pct, text) {
      uploadBar.style.width = Math.max(0, Math.min(100, pct)) + "%";
      uploadInfo.textContent = text || "";
    }

    loadServers();
  </script>

  <script>
  (function() {
    const currentVersion = '2025-11-07v5';
    const key = 'gestor_html_version';
    const last = localStorage.getItem(key);
    if (last !== currentVersion) {
      localStorage.setItem(key, currentVersion);
      console.log('üß© Nueva versi√≥n detectada ‚Äî recargando sin cach√©...');
      fetch(window.location.href + '?v=' + currentVersion, { cache: 'reload' })
        .then(() => window.location.reload(true))
        .catch(() => window.location.reload(true));
      return;
    }
  })();
  </script>
</body>
</html>
